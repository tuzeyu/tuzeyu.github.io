<!DOCTYPE html>
<html lang="en"></html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="./src/face-api.js"></script>
  <script src="./src/faceDetectionControls.js"></script>
  <script type="text/javascript" src="./src/jquery-2.1.1.min.js"></script>
  <script src="./src/materialize.min.js"></script>
  <!-- <link rel="stylesheet" href="./src/materialize.css"> -->

  <style>
    .video {
      position: relative;
      width: 640px;
      height: 480px;
      transform: scale(0.5);
/*       margin: 100px auto; */
    }

    video {
      height: 100%;
      object-fit: fill;
    }

    #snap {
      position: absolute;
      top: 0;
      left: 0;
      display: none;
    }

    #overlay {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>

<body>
  <div>
    <div class='video'>
      <video 
        onloadedmetadata="onPlay(this)" 
        id="inputVideo" 
        autoplay="" 
        muted=""
        playsinline="">
      </video>
      <canvas id="overlay"></canvas>
      <canvas id='snap' width="640" height="480"></canvas>
    </div>
  </div>
  <script>
    let forwardTimes = []
    let withBoxes = true
    let scores = []

    function avg(array) {//封装求平均值函数
        var len = array.length;
        var sum = 0;
        for(var i = 0;i<len;i++){
            sum +=array[i];
        }
        return sum/len;
    }

    async function onPlay() {
      const videoEl = $('#inputVideo').get(0)
      if (videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
        return setTimeout(() => onPlay())
      const options = getFaceDetectorOptions()
      const ts = Date.now()
      const result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks()
      console.log(result)
      if (result) {
        const canvas = $('#overlay').get(0)
        const dims = faceapi.matchDimensions(canvas, videoEl, true)
        const resizedResult = faceapi.resizeResults(result, dims)
        if (withBoxes) {
          faceapi.draw.drawDetections(canvas, resizedResult)
        }
        faceapi.draw.drawFaceLandmarks(canvas, resizedResult)
      }

      if (result) {
        scores.push(result.alignedRect.score)
        if (scores.length>10) {
          scores.shift()
        }
      }

      if(result && scores.length == 10 && avg(scores) > 0.85 && result.alignedRect.score>0.95) {
        let snapConvas = document.getElementById('snap')      
        snapConvas.getContext("2d").drawImage(videoEl, 0, 0, snapConvas.width, snapConvas.height)
        $(snapConvas).show()
      } else {
        setTimeout(() => onPlay(), 200)
      }
    }

    async function run() {
      await changeFaceDetector()
      await faceapi.loadFaceLandmarkModel('/model/')
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {}
      })
      const videoEl = $('#inputVideo').get(0)
      videoEl.srcObject = stream
    }

    $(document).ready(function () {
      run()
    })
  </script>
</body>

</html>
